<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rimuru Store V5.9 Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-user-select: none; background: #070b14; color: white; font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.49); }
        @keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .low-stock { animation: pulse-red 1.5s infinite; color: #ff4d4d; font-weight: 900; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .modal-overlay { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        /* SHIMMER EFFECT ANIMATION */
        .shimmer-btn {
            position: relative;
            overflow: hidden;
        }
        .shimmer-btn::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="resultModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border-2 border-emerald-500 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 bg-emerald-600/20 border-b border-emerald-500/20 text-center">
            <h2 class="text-emerald-400 font-black tracking-widest uppercase italic text-sm">ğŸ› THANKS FOR ORDERğŸ¤™ğŸ¼</h2>
        </div>
        <div class="p-8 text-center">
            <p id="resPaket" class="text-[10px] text-slate-400 font-bold uppercase mb-2"></p>
            <div class="bg-slate-950 p-4 rounded-2xl border border-slate-800 mb-6">
                <p id="resAccount" class="text-white font-mono text-sm break-all font-bold"></p>
            </div>
            <button onclick="copyAccountResult()" class="w-full bg-emerald-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg active:scale-95 mb-3">Salin Akun</button>
            <button onclick="closeModal('resultModal'); location.reload();" class="w-full bg-slate-800 p-4 rounded-2xl font-black text-xs uppercase text-slate-400">Tutup</button>
        </div>
    </div>
</div>

<div id="userPassModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 bg-slate-800/50 border-b border-slate-800 text-center">
            <h2 class="text-blue-400 font-black tracking-widest uppercase text-sm italic">ğŸ” GANTI PASSWORD</h2>
        </div>
        <div class="p-6 space-y-4">
            <input type="password" id="u_newpass" placeholder="Password Baru" class="w-full p-4 bg-slate-950 rounded-2xl border border-slate-700 text-white outline-none text-center text-sm">
            <button onclick="submitUserPass(event)" id="btnUserPass" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg">Simpan Password</button>
        </div>
        <div class="p-4 pt-0">
            <button onclick="closeModal('userPassModal')" class="w-full bg-slate-800 p-3 rounded-2xl font-black text-[10px] uppercase">Batal</button>
        </div>
    </div>
</div>

<div id="resellerModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border border-blue-500/50 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 bg-blue-600/20 border-b border-blue-500/20 text-center">
            <h2 class="text-blue-400 font-black tracking-widest uppercase italic text-sm">ğŸ’° PRICE USERS</h2>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh] text-xs space-y-4 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter mb-4 italic">"PRICE YANG HARUS USER TRANSFER KE ADMIN GANTENG"</p>
            <div class="grid grid-cols-2 gap-4 text-left px-4">
                <div class="text-slate-300">Paket 10k<br>Paket Hemat<br>Paket 1<br>Paket 2<br>Paket 3<br>Paket 4<br>Paket 5</div>
                <div class="text-emerald-400 font-bold">ğŸ’¸ 5k<br>ğŸ’¸ 10k<br>ğŸ’¸ 15k<br>ğŸ’¸ 30k<br>ğŸ’¸ 75k<br>ğŸ’¸ 75k<br>ğŸ’¸ 100k</div>
            </div>
            <div class="border-t border-slate-800 my-4 pt-4 grid grid-cols-2 gap-4 text-left px-4">
                <div class="text-slate-300">Safeban Newbie<br>Safeban Pro</div>
                <div class="text-orange-400 font-bold">ğŸ’¸ 50k<br>ğŸ’¸ 100k</div>
            </div>
        </div>
        <div class="p-4"><button onclick="closeModal('resellerModal')" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg">Tutup</button></div>
    </div>
</div>

<div id="updateModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 bg-slate-800/50 border-b border-slate-800 text-center">
            <h2 class="text-slate-300 font-black tracking-widest uppercase text-sm italic">ğŸ“¢ UPDATE LOG</h2>
        </div> 
        <div class="p-6 overflow-y-auto max-h-[60vh] text-[11px] space-y-4">
            <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                <p class="text-emerald-400 font-bold mb-1">âœ… V8.8: Auto Monthly Report</p>
                <p class="text-slate-400">Laporan otomatis omset bulanan dikirim langsung ke bot Telegram admin.</p>
            </div>
            <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                <p class="text-orange-400 font-bold mb-1">ğŸš€ V8.6: Admin Revenue x2</p>
                <p class="text-slate-400">Logika harga otomatis x2 jika di-generate oleh Rimuru (Admin).</p>
            </div>
            <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                <p class="text-sky-400 font-bold mb-1">âœ… V5.8: PRO Dashboard</p>
                <p class="text-slate-400">Pembaruan tampilan Glassmorphism dan Grafik penjualan.</p>
            </div>
        </div>
        <div class="p-4"><button onclick="closeModal('updateModal')" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg">Tutup</button></div>
    </div>
</div>

<div id="priceModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-md max-h-[85vh] rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
            <h2 class="text-blue-400 font-black tracking-widest text-sm uppercase italic">ğŸ“‹ PRICE RIMURU</h2>
            <button onclick="closeModal('priceModal')" class="text-slate-500 font-bold text-xl">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto text-[10px] space-y-4 whitespace-pre-wrap custom-scrollbar text-slate-300">
âœï¸PAKET 10k
â—GOLD & MONEY 999M
â—LEVEL MAX
â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ«âŠ°âŠ¹â”€â”€â”€â”€â”€â”€
            
âœï¸PAKET HEMAT UNLOCK MOUNTAIN MAP 
â—1B GOLD & 2B DOLLAR UNLIMITED , MAX LEVEL 50
â—UNLOCK 2 MOUNTAIN MAP
ğŸ’µPRICE IDR = 20K
ğŸ’µPRICE MY = 6RM
ğŸ’µPRICE OVERSEAS = 2$
â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ«âŠ°âŠ¹â”€â”€â”€â”€â”€â”€

âœï¸PAKET 1 [NEWBIE]
â—GOLD & DOLLAR UNLIMITED , MAX LEVEL 50
â—Premium Car S80 Royal Lynx & M36 + elite Apartement
â—GET BONUS CAR FF4 Technoir & LMD lamborghini Diablo Midnight Phoenix , BX5 , Aston martin AMV & Lexus LFA
â— UNLOCK 2 MOUNTAIN MAP
â— UNLOCK SUNSET CITY CIRCUIT

ğŸ’µPRICE IDR = 30K
ğŸ’µPRICE MY = 9RM
ğŸ’µPRICE OVERSEAS = 4$
â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ«âŠ°âŠ¹â”€â”€â”€â”€â”€â”€

âœï¸PAKET 2 [ELITE NEWBIE]
â—GOLD & DOLLAR UNLIMITED , MAX LEVEL 50
â—GET BONUS CAR FF4 Technoir, LMD lamborghini Diablo Midnight Phoenix, BX5 Hill Runner, AR8 Fiery Blast, ELITE GT aston martin, ROCKET STAR Lexus LFL  and NEW FORD GT AND PORCHE GT
â— UNLOCK MOUNTAIN MAP
â— UNLOCK SUNSET CITY CIRCUIT

ğŸ’µPRICE IDR = 60K
ğŸ’µPRICE MY = 18RM
ğŸ’µPRICE OVERSEAS = 7$
â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ«âŠ°âŠ¹â”€â”€â”€â”€â”€â”€

âœï¸PAKET 3 [ALL PREMIUM CAR]
â—GOLD & DOLLAR UNLIMITED, MAX LEVEL 50
â—UNLOCK MOUNTAIN HILLS PASS (NEW MAP)
â—UNLOCK SUNSET CITY CIRCUIT
â—35 MOBIL/CAR PREMIUM (Include 4 Elite Apartement)
â— UNLOCK NEW PREMIUM CAR Lexus LFA & Aston martin AMV, SUPER rare VAN, PORCHE GT( 2 ) , FORD GT ( 2 )  M39 Touring, GCLASS Christmas edition, NEW premium car TESLA AND RARE BATTLEPASS LAMBO AVENTADOR
â— ALL Car unlimited Nos++


ğŸ’µPRICE IDR = 150K
ğŸ’µPRICE MY = 53RM
ğŸ’µPRICE OVERSEAS = 15$
â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ«âŠ°âŠ¹â”€â”€â”€â”€â”€â”€

âœï¸PAKET 4 [500KMH KMH]
â—GOLD & DOLLAR UNLIMITED, MAX LEVEL 50
â—UNLOCK MOUNTAIN HILLS PASS (NEW MAP)
â— UNLOCK SUNSET CITY CIRCUIT
â—UNLIMITED NOS CARS IN GARAGE (45 CAR)
â—INJECT 500++ KM/H CARS IN GARAGE (45 CAR)
â—UNLOCK 4 RARE PREMIUM CAR LMD,FF4, BX5, AR8) Include 4 Elite House.
â— UNLOCK NEW PREMIUM CAR Lexus LFA & Aston martin AMV, VIPER, VAN, M39TOURING, PORCHE GT, FORD GT, GWAGON, TESLA, AND RARE BATTLEPASS LAMBO AVENTADOR
â—BONUS WHEELIE SUPRA S80, NEW GCLASS & NEW TESLA

ğŸ’µPRICE IDR = 150K
ğŸ’µPRICE MY = 45RM
ğŸ’µPRICE Overseas = 12$
â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ«âŠ°âŠ¹â”€â”€â”€â”€â”€â”€

âœï¸PAKET 5 [ DRIFT TUNES ]
â—GOLD & DOLLAR UNLIMITED, MAX LEVEL 50
â—UNLOCK MOUNTAIN HILLS PASS (NEW MAP)
â— UNLOCK SUNSET CITY CIRCUIT
â—DRIFT TUNES RWD (44 CAR)
â—UNLOCK 4 RARE PREMIUM CARS  (Include 4 Elite House) LMD, FF4, BX5, AR8 & VAN
â—UNLOCK SPECIAL CHRISMAST EVENT M92C BMW E92 CABRIO SUPER RARE
â— UNLOCK NEW PREMIUM CAR Lexus LFA, Aston martin & VIPER, M39 TOURING,
PORCHE GT, NEW GCLASS, NEW TESLA AWD & TESLA RWD AND RARE BATTLEPASS LAMBO AVENTADOR

ğŸ’µPRICE IDR = 200K
ğŸ’µPRICE MY = 60RM
ğŸ’µPRICE OVERSEAS = 20$
â”€â”€â”€â”€â”€â”€âŠ¹âŠ±âœ«âŠ°âŠ¹â”€â”€â”€â”€â”€â”€

Price Akun Safeban

Safeban Newbie
Unlock allmap
Max level
Silver 21M
Gold 10.000
50 mobil premium (Showroom tune)

Price : 100k

Safeban Pro
Gold & Silver 888M
Unlock allmap
40+ Drift tune car (include tesla RWD)

Price : 200k

.COLOR NAME  -20K

.INJECT PREMIUM CARS 1 MOBIL -20K
        </div>
        <div class="p-4 bg-slate-800/30 border-t border-slate-800">
            <button onclick="closeModal('priceModal')" class="w-full bg-slate-800 p-3 rounded-2xl font-black text-[10px] uppercase shadow-lg">Tutup</button>
        </div>
    </div>
</div>

<div id="loginSection" class="flex h-screen items-center justify-center p-6 bg-slate-950">
    <div class="glass-card p-8 rounded-3xl w-full max-w-sm shadow-2xl">
        <h2 class="text-3xl font-black text-center mb-6 text-blue-400 italic">RIMURU</h2>
        <input type="text" id="user" placeholder="Username" class="w-full p-4 mb-3 bg-slate-900/50 rounded-2xl border border-slate-700 outline-none text-white text-center">
        <input type="password" id="pass" placeholder="Password" class="w-full p-4 mb-6 bg-slate-900/50 rounded-2xl border border-slate-700 outline-none text-white text-center">
        <button onclick="handleLogin()" id="btnLogin" class="w-full bg-blue-600 p-4 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-all">Masuk</button>
    </div>
</div>

<div id="appSection" class="hidden p-4 max-w-md mx-auto pb-12">
    <div class="flex justify-between items-center mb-6 mt-4">
        <div>
            <h1 class="text-xl font-black text-blue-400 italic">RIMURU STORE</h1>
            <p id="userStatusTag" class="text-[9px] text-slate-500 font-bold mt-2 tracking-widest uppercase italic"></p>
        </div>
        <div class="flex gap-2">
            <button onclick="openModal('userPassModal')" class="bg-blue-600/10 text-blue-400 px-4 py-2 rounded-xl text-[10px] font-black border border-blue-500/20 active:scale-90">PASS</button>
            <button onclick="handleLogout()" class="bg-red-500/10 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black border border-red-500/20 active:scale-90">LOGOUT</button>
        </div>
    </div>

    <div class="glass-card p-4 rounded-2xl mb-6 flex justify-between items-center text-sm font-black italic">
        <span class="text-slate-400 text-[10px]">OMSET ANDA:</span>
        <span id="userRevenue" class="text-emerald-400">Rp 0</span>
    </div>

    <div class="grid grid-cols-2 gap-2 mb-2">
        <button onclick="openModal('priceModal')" class="glass-card p-4 rounded-2xl text-emerald-400 font-black text-[10px] tracking-widest shadow-lg">ğŸ“‹ PRICE RIMURU</button>
        <button onclick="openModal('updateModal')" class="glass-card p-4 rounded-2xl text-slate-400 font-black text-[10px] tracking-widest shadow-lg italic">ğŸ“¢ WHAT'S NEW</button>
    </div>
    <button onclick="openModal('resellerModal')" class="w-full glass-card p-4 rounded-2xl text-blue-400 font-black text-[10px] tracking-[0.3em] mb-6 shadow-lg">ğŸ’° PRICE USERS</button>

    <div id="adminPanel" class="hidden mb-6 space-y-2">
        <div class="p-4 bg-orange-500/10 border border-orange-500/30 rounded-2xl">
            <h3 class="text-orange-400 font-black text-[10px] uppercase mb-4 tracking-widest text-center">ğŸ›¡ï¸ ADMIN CONTROL PANEL</h3>
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 mb-4">
                <canvas id="adminChart" class="w-full h-32"></canvas>
            </div>
            <div class="bg-slate-900/80 p-3 rounded-xl border border-orange-500/20 mb-4 flex justify-between items-center">
                <span class="text-slate-500 text-[9px] font-black uppercase italic">OMSET KESELURUHAN:</span>
                <div id="adminGlobalRevenue" class="text-right">
                    <span class="text-orange-400 font-bold text-xs">Rp 0</span>
                </div>
            </div>
            <button onclick="syncDatabase()" id="btnSync" class="w-full bg-emerald-600 p-4 rounded-2xl font-black text-[10px] uppercase shadow-lg mb-4 active:scale-95 shimmer-btn">ğŸ§¹ RAPIHKAN SHEET</button>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="showAdminFeature('addUser')" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-slate-300 border border-slate-700">+ USER</button>
                <button onclick="showAdminFeature('addStock')" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-slate-300 border border-slate-700">+ STOK</button>
                <button onclick="showAdminFeature('deleteUser')" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-red-400 border border-red-500/30">HAPUS USER</button>
                <button onclick="showAdminFeature('changePass')" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-slate-300 border border-slate-700">ADM PASS</button>
            </div>
            <div id="adminForm" class="hidden mt-4 pt-4 border-t border-slate-800 space-y-3">
                <div id="formContent"></div>
                <button id="btnAdminSubmit" onclick="submitAdminAction()" class="w-full bg-orange-600 p-3 rounded-xl font-black text-[10px] uppercase">Submit Action</button>
            </div>
        </div>
    </div>

    <div class="glass-card p-6 rounded-[2rem] mb-6 shadow-xl border-t border-white/5">
        <label class="text-[10px] text-slate-400 font-bold mb-2 block uppercase tracking-widest italic">Pilih Paket:</label>
        <select id="paket" class="w-full p-4 mb-4 bg-slate-950 rounded-2xl border border-slate-800 text-sm text-white outline-none focus:border-blue-500"></select>
        <label class="text-[10px] text-slate-400 font-bold mb-2 block uppercase tracking-widest italic">Bukti Transfer:</label>
        <input type="file" id="bukti" accept="image/*" class="w-full text-xs text-slate-500 mb-6 file:py-2 file:px-4 file:rounded-xl file:bg-blue-600 file:text-white file:font-bold">
        <button id="btnGen" disabled onclick="handleGen()" class="w-full bg-blue-600 disabled:bg-slate-800 p-4 rounded-2xl font-black uppercase text-sm shadow-lg active:scale-95 shimmer-btn">Generate Akun</button>
    </div>

    <div class="glass-card p-6 rounded-[2rem] mb-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest italic">Riwayat Transaksi</h3>
            <span class="text-[8px] text-emerald-500 font-bold uppercase tracking-tighter">Terbaru</span>
        </div>
        <div id="historyList" class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar"></div>
    </div>
</div>

<script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzrX_iVdpJsAbuqqdZKBZ08BAUdqgyQCiAU3p563p9Lc3gi7jarLMjPs8BWT16QY76o/exec"; 
    const PAKET_LIST = ["Paket 10k", "Paket Hemat", "Paket 1", "Paket 2", "Paket 3", "Paket 4", "Paket 5", "Paket 6", "Safeban Newbie", "Safeban Pro"];
    let base64Img = "", currentUser = "", currentRole = "", sessionToken = "", currentAdminAction = "";

    async function secureFetch(payload) {
        if(sessionToken) payload.token = sessionToken;
        const res = await fetch(WEBAPP_URL, { method: "POST", body: JSON.stringify(payload) });
        const data = await res.json();
        if(data && data.status === "invalid_session"){ localStorage.clear(); location.reload(); return null; }
        return data;
    }

    window.onload = function() {
        const savedToken = localStorage.getItem("rimuru_token"), savedUser = localStorage.getItem("rimuru_user"), savedRole = localStorage.getItem("rimuru_role");
        if(savedToken && savedUser && savedRole){ sessionToken = savedToken; currentUser = savedUser; currentRole = savedRole; showApp(savedRole); }
    };

    function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
    function openModal(id){ document.getElementById(id).classList.remove('hidden'); }

    async function handleLogin(){
        const user = document.getElementById('user').value, pass = document.getElementById('pass').value, btn = document.getElementById('btnLogin');
        if(!user || !pass) return alert("Isi Data!");
        btn.innerText = "CHECKING..."; btn.disabled = true;
        try {
            const res = await fetch(WEBAPP_URL,{ method:"POST", body: JSON.stringify({action:"login", user, pass}) });
            const data = await res.json();
            if(data.status === "success"){
                sessionToken = data.token; currentUser = user; currentRole = data.role;
                localStorage.setItem("rimuru_token", sessionToken); localStorage.setItem("rimuru_user", user); localStorage.setItem("rimuru_role", data.role);
                showApp(data.role);
            } else { alert(data.msg); btn.innerText = "Masuk"; btn.disabled = false; }
        } catch(e) { alert("Gagal koneksi ke server!"); btn.innerText = "Masuk"; btn.disabled = false; }
    }

    async function showApp(role){
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        document.getElementById('userStatusTag').innerText = "Logged in as : " + currentUser;
        updateStockUI(); loadHistory(); updateUserStats();
        if(role === "admin"){ 
            document.getElementById('adminPanel').classList.remove('hidden'); 
            document.getElementById('btnGen').disabled = false; 
            fetchAdminStats(); 
        }
    }

    async function handleGen(){
        const btn = document.getElementById('btnGen'); btn.innerText="GENERATE..."; btn.disabled=true;
        const data = await secureFetch({ action:"generate", paket: document.getElementById('paket').value, image: base64Img });
        if(data && data.status === "success"){
            document.getElementById('resPaket').innerText=data.paket;
            document.getElementById('resAccount').innerText=data.email+" | "+data.pass;
            openModal('resultModal');
        } else { alert(data?data.msg:"Akun di kategori ini sudah habis!"); btn.innerText="Generate Akun"; btn.disabled=false; }
    }

    async function submitUserPass(e){
        e.preventDefault();
        const newPass = document.getElementById('u_newpass').value;
        if(!newPass) return alert("Isi password baru!");
        const btn = document.getElementById('btnUserPass'); btn.innerText="SAVING..."; btn.disabled=true;
        const data = await secureFetch({action:"changePass", newPass: newPass});
        if(data){ alert(data.msg); closeModal('userPassModal'); }
        btn.innerText="Simpan Password"; btn.disabled=false;
    }

    function showAdminFeature(type){
        currentAdminAction = type;
        const form = document.getElementById('adminForm'), content = document.getElementById('formContent');
        form.classList.remove('hidden');
        if(type === "addUser") content.innerHTML = `<input id="adm_user" placeholder="Username Baru" class="w-full p-3 bg-slate-950 border border-slate-700 rounded-xl text-white text-xs mb-2"><input id="adm_pass" type="password" placeholder="Password" class="w-full p-3 bg-slate-950 border border-slate-700 rounded-xl text-white text-xs">`;
        else if(type === "addStock") content.innerHTML = `<select id="adm_paket" class="w-full p-3 bg-slate-950 border border-slate-700 rounded-xl text-white text-xs mb-2">${PAKET_LIST.map(p=>`<option value="${p}">${p}</option>`).join('')}</select><textarea id="adm_data" placeholder="email|password (satu baris satu akun)" class="w-full p-3 bg-slate-950 border border-slate-700 rounded-xl text-white text-xs h-32"></textarea>`;
        else if(type === "changePass") content.innerHTML = `<input id="adm_newpass" type="password" placeholder="Password Admin Baru" class="w-full p-3 bg-slate-950 border border-slate-700 rounded-xl text-white text-xs">`;
        else if(type === "deleteUser") content.innerHTML = `<input id="adm_del_user" placeholder="Username yang akan dihapus" class="w-full p-3 bg-slate-950 border border-slate-700 rounded-xl text-white text-xs italic">`;
    }

    async function submitAdminAction(){
        const btn=document.getElementById('btnAdminSubmit'); btn.innerText="PROSES..."; btn.disabled=true;
        let payload={action:currentAdminAction};
        if(currentAdminAction==="addUser"){ payload.newUser=document.getElementById('adm_user').value; payload.newPass=document.getElementById('adm_pass').value; }
        else if(currentAdminAction==="addStock"){ payload.paket=document.getElementById('adm_paket').value; payload.dataAkun=document.getElementById('adm_data').value; }
        else if(currentAdminAction==="changePass"){ payload.newPass=document.getElementById('adm_newpass').value; }
        else if(currentAdminAction==="deleteUser"){ payload.targetUser=document.getElementById('adm_del_user').value; if(!confirm("Hapus "+payload.targetUser+"?")) { btn.innerText="Submit Action"; btn.disabled=false; return; } }
        const data=await secureFetch(payload);
        if(data){ alert(data.msg); location.reload(); }
        btn.innerText="Submit Action"; btn.disabled=false;
    }

    async function loadHistory(){
        const data=await secureFetch({action:"getHistory"});
        if(data && data.data){
            document.getElementById('historyList').innerHTML=data.data.map(h=>{
                const acc = h.email + " | " + h.pass;
                return `<div class="bg-slate-900/50 p-4 rounded-2xl border-l-4 ${h.isLast?'border-emerald-500':'border-blue-500'} mb-2">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[9px] font-black uppercase ${h.isLast?'text-emerald-400':'text-blue-400'}">${h.paket}</span>
                        <span class="text-[8px] text-slate-500 font-bold italic">${h.time} WIB</span>
                    </div>
                    <p class="text-xs font-mono text-white opacity-80 mb-2 break-all">${acc}</p>
                    <button onclick="copyToClipboard('${acc}')" class="text-[8px] bg-blue-600/20 text-blue-400 px-2 py-1 rounded border border-blue-500/20 uppercase font-bold active:scale-95">Salin</button>
                </div>`;
            }).join('');
        }
    }

    function copyToClipboard(text){ navigator.clipboard.writeText(text); alert("Disalin!"); }
    function copyAccountResult(){ copyToClipboard(document.getElementById('resAccount').innerText); }
    
    async function updateStockUI(){
        const data=await secureFetch({action:"getStockDetail"});
        if(data && data.stockMap) document.getElementById('paket').innerHTML=PAKET_LIST.map(p=>{
            const s=data.stockMap[p]||0;
            return `<option value="${p}" ${s===0?'disabled':''}>${p} (${s} ${s<3&&s>0?'ğŸ”¥':'Ready'})</option>`;
        }).join('');
    }

    async function syncDatabase(){ 
        const btn = document.getElementById('btnSync');
        const originalText = btn.innerText;
        btn.innerText = "CLEANING..."; btn.disabled = true;
        try {
            const data = await secureFetch({action:"syncSheet"}); 
            if(data){ alert(data.msg); location.reload(); } 
        } catch(e) {
            alert("Gagal merapihkan sheet!");
        } finally {
            btn.innerText = originalText; btn.disabled = false;
        }
    }

    async function updateUserStats(){ const d=await secureFetch({action:"getUserStats"}); if(d) document.getElementById('userRevenue').innerText="Rp "+(d.revenue||0).toLocaleString(); }
    
    async function fetchAdminStats(){
        const data = await secureFetch({action:"getStats"});
        if(data){
            document.getElementById('adminGlobalRevenue').innerHTML = `
                <div class="flex flex-col">
                    <span class="text-orange-400 font-bold text-[11px]">ADM: Rp ${(data.adminRevenue || 0).toLocaleString()}</span>
                    <span class="text-emerald-400 font-bold text-[11px]">RES: Rp ${(data.resellerRevenue || 0).toLocaleString()}</span>
                    <span class="text-slate-400 text-[8px] border-t border-slate-700 mt-1">TOTAL: Rp ${(data.revenue || 0).toLocaleString()}</span>
                </div>
            `;
            if(data.chartData) {
                new Chart(document.getElementById('adminChart'), { 
                    type: 'bar', 
                    data: { labels: Object.keys(data.chartData), datasets: [{ data: Object.values(data.chartData), backgroundColor: '#3b82f6' }] }, 
                    options: { plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true, grid:{display:false}, ticks:{display:false}}, x:{grid:{display:false}, ticks:{color:'#64748b', font:{size:8}}} } } 
                });
            }
        }
    }

    function handleLogout(){ if(confirm("Keluar?")){ localStorage.clear(); location.reload(); } }
    document.getElementById('bukti').onchange=(e)=>{ 
        if(!e.target.files[0]) return;
        const r=new FileReader(); 
        r.onload=()=>{ base64Img=r.result; document.getElementById('btnGen').disabled=false; }; 
        r.readAsDataURL(e.target.files[0]); 
    };
</script>
</body>
</html>

