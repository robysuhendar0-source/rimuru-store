<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rimuru Store V5.8 Official</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-user-select: none; background: #070b14; color: white; font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.49); }
        @keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Glassmorphism Effect */
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Low Stock Warning Animation */
        .low-stock { animation: pulse-red 1.5s infinite; color: #ff4d4d; font-weight: 900; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .modal-overlay { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="resultModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border-2 border-emerald-500 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 bg-emerald-600/20 border-b border-emerald-500/20 text-center">
            <h2 class="text-emerald-400 font-black tracking-widest uppercase italic text-sm">‚ú® THANKS FOR ORDERü§ôüèº</h2>
        </div>
        <div class="p-8 text-center">
            <p id="resPaket" class="text-[10px] text-slate-400 font-bold uppercase mb-2"></p>
            <div class="bg-slate-950 p-4 rounded-2xl border border-slate-800 mb-6">
                <p id="resAccount" class="text-white font-mono text-sm break-all font-bold"></p>
            </div>
            <button onclick="copyAccountResult()" class="w-full bg-emerald-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg active:scale-95 mb-3">Salin Akun</button>
            <button onclick="closeModal('resultModal'); location.reload();" class="w-full bg-slate-800 p-4 rounded-2xl font-black text-xs uppercase text-slate-400">Tutup</button>
        </div>
    </div>
</div>

<div id="userPassModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onclick="/* Lock Overlay */">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl" onclick="event.stopPropagation()">
        <div class="p-6 bg-slate-800/50 border-b border-slate-800 text-center">
            <h2 class="text-blue-400 font-black tracking-widest uppercase text-sm italic">üîê GANTI PASSWORD</h2>
        </div>
        <div class="p-6 space-y-4">
            <input type="password" id="u_newpass" placeholder="Password Baru" class="w-full p-4 bg-slate-950 rounded-2xl border border-slate-700 text-white outline-none text-center text-sm">
            <button onclick="submitUserPass(event)" id="btnUserPass" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg">Simpan Password</button>
        </div>
        <div class="p-4 pt-0">
            <button onclick="closeModal('userPassModal')" class="w-full bg-slate-800 p-3 rounded-2xl font-black text-[10px] uppercase">Batal</button>
        </div>
    </div>
</div>

<div id="resellerModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border border-blue-500/50 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 bg-blue-600/20 border-b border-blue-500/20 text-center">
            <h2 class="text-blue-400 font-black tracking-widest uppercase italic text-sm">üí∞ PRICE USERS</h2>
        </div>
        <div class="p-6 overflow-y-auto max-h-[60vh] text-xs space-y-4 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter mb-4 italic">"PRICE YANG HARUS USER TRANSFER KE ADMIN GANTENG"</p>
            <div class="grid grid-cols-2 gap-4 text-left px-4">
                <div class="text-slate-300">Paket 10k<br>Paket Hemat<br>Paket 1<br>Paket 2<br>Paket 3<br>Paket 4<br>Paket 5</div>
                <div class="text-emerald-400 font-bold">üí∏ 5k<br>üí∏ 10k<br>üí∏ 15k<br>üí∏ 30k<br>üí∏ 75k<br>üí∏ 75k<br>üí∏ 100k</div>
            </div>
            <div class="border-t border-slate-800 my-4 pt-4 grid grid-cols-2 gap-4 text-left px-4">
                <div class="text-slate-300">Safeban Newbie<br>Safeban Pro</div>
                <div class="text-orange-400 font-bold">üí∏ 50k<br>üí∏ 100k</div>
            </div>
        </div>
        <div class="p-4"><button onclick="closeModal('resellerModal')" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg">Tutup</button></div>
    </div>
</div>

<div id="updateModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 bg-slate-800/50 border-b border-slate-800 text-center">
            <h2 class="text-slate-300 font-black tracking-widest uppercase text-sm italic">üì¢ UPDATE LOG</h2>
        </div> 
        <div class="p-6 overflow-y-auto max-h-[60vh] text-[11px] space-y-4">
            <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                <p class="text-emerald-400 font-bold mb-1">‚úÖ V7.2: Upgrade Performance</p>
                <p class="text-slate-400">Pemisahan Database SOLD & READY + Auto-Sorting".</p>
            </div>
            <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                <p class="text-orange-400 font-bold mb-1">üöÄ V7.0: Telegram Bot</p>
                <p class="text-slate-400">Integrasi bot notifikasi Telegram otomatis.</p>
            </div>
            <div class="bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
                <p class="text-sky-400 font-bold mb-1">‚úÖ V5.8: PRO Database</p>
                <p class="text-slate-400">Database di kontrol penuh oleh Admin, walaupun user ganti pw Admin akan tau pw tersebut, kalau lupa bisa tanya admin langsung.</p>
            </div>
        </div>
        <div class="p-4"><button onclick="closeModal('updateModal')" class="w-full bg-blue-600 p-4 rounded-2xl font-black text-xs uppercase shadow-lg">Tutup</button></div>
    </div>
</div>

<div id="priceModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-md max-h-[85vh] rounded-[2.5rem] overflow-hidden flex flex-col animate-pop shadow-2xl">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-800/50">
            <h2 class="text-blue-400 font-black tracking-widest text-sm uppercase italic">üìã PRICE RIMURU</h2>
            <button onclick="closeModal('priceModal')" class="text-slate-500 font-bold text-xl">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto text-[10px] space-y-4 whitespace-pre-wrap custom-scrollbar text-slate-300">
‚úçÔ∏èPAKET HEMAT UNLOCK MOUNTAIN MAP 
‚óè1B GOLD & 2B DOLLAR UNLIMITED , MAX LEVEL 50
‚óèUNLOCK 2 MOUNTAIN MAP
üíµPRICE IDR = 20K
üíµPRICE MY = 6RM
üíµPRICE OVERSEAS = 2$
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚äπ‚ä±‚ú´‚ä∞‚äπ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚úçÔ∏èPAKET 1 [NEWBIE]
‚óèGOLD & DOLLAR UNLIMITED , MAX LEVEL 50
‚óèPremium Car S80 Royal Lynx & M36 + elite Apartement
‚óèGET BONUS CAR FF4 Technoir & LMD lamborghini Diablo Midnight Phoenix , BX5 , Aston martin AMV & Lexus LFA
‚óè UNLOCK 2 MOUNTAIN MAP
‚óè UNLOCK SUNSET CITY CIRCUIT

üíµPRICE IDR = 30K
üíµPRICE MY = 9RM
üíµPRICE OVERSEAS = 4$
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚äπ‚ä±‚ú´‚ä∞‚äπ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚úçÔ∏èPAKET 2 [ELITE NEWBIE]
‚óèGOLD & DOLLAR UNLIMITED , MAX LEVEL 50
‚óèGET BONUS CAR FF4 Technoir, LMD lamborghini Diablo Midnight Phoenix, BX5 Hill Runner, AR8 Fiery Blast, ELITE GT aston martin, ROCKET STAR Lexus LFL  and NEW FORD GT AND PORCHE GT
‚óè UNLOCK MOUNTAIN MAP
‚óè UNLOCK SUNSET CITY CIRCUIT

üíµPRICE IDR = 60K
üíµPRICE MY = 18RM
üíµPRICE OVERSEAS = 7$
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚äπ‚ä±‚ú´‚ä∞‚äπ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚úçÔ∏èPAKET 3 [ALL PREMIUM CAR]
‚óèGOLD & DOLLAR UNLIMITED, MAX LEVEL 50
‚óèUNLOCK MOUNTAIN HILLS PASS (NEW MAP)
‚óèUNLOCK SUNSET CITY CIRCUIT
‚óè35 MOBIL/CAR PREMIUM (Include 4 Elite Apartement)
‚óè UNLOCK NEW PREMIUM CAR Lexus LFA & Aston martin AMV, SUPER rare VAN, PORCHE GT( 2 ) , FORD GT ( 2 )  M39 Touring, GCLASS Christmas edition, NEW premium car TESLA AND RARE BATTLEPASS LAMBO AVENTADOR
‚óè ALL Car unlimited Nos++

üíµPRICE IDR = 150K
üíµPRICE MY = 53RM
üíµPRICE OVERSEAS = 15$
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚äπ‚ä±‚ú´‚ä∞‚äπ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚úçÔ∏èPAKET 4 [500KMH KMH]
‚óèGOLD & DOLLAR UNLIMITED, MAX LEVEL 50
‚óèUNLOCK MOUNTAIN HILLS PASS (NEW MAP)
‚óè UNLOCK SUNSET CITY CIRCUIT
‚óèUNLIMITED NOS CARS IN GARAGE (45 CAR)
‚óèINJECT 500++ KM/H CARS IN GARAGE (45 CAR)
‚óèUNLOCK 4 RARE PREMIUM CAR LMD,FF4, BX5, AR8) Include 4 Elite House.
‚óè UNLOCK NEW PREMIUM CAR Lexus LFA & Aston martin AMV, VIPER, VAN, M39TOURING, PORCHE GT, FORD GT, GWAGON, TESLA, AND RARE BATTLEPASS LAMBO AVENTADOR
‚óèBONUS WHEELIE SUPRA S80, NEW GCLASS & NEW TESLA

üíµPRICE IDR = 150K
üíµPRICE MY = 45RM
üíµPRICE Overseas = 12$
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚äπ‚ä±‚ú´‚ä∞‚äπ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

‚úçÔ∏èPAKET 5 [ DRIFT TUNES BY OGX STREET ]
‚óèGOLD & DOLLAR UNLIMITED, MAX LEVEL 50
‚óèUNLOCK MOUNTAIN HILLS PASS (NEW MAP)
‚óè UNLOCK SUNSET CITY CIRCUIT
‚óèDRIFT TUNES RWD (44 CAR)
‚óèUNLOCK 4 RARE PREMIUM CARS  (Include 4 Elite House) LMD, FF4, BX5, AR8 & VAN
‚óèUNLOCK SPECIAL CHRISMAST EVENT M92C BMW E92 CABRIO SUPER RARE
‚óè UNLOCK NEW PREMIUM CAR Lexus LFA, Aston martin & VIPER, M39 TOURING,
PORCHE GT, NEW GCLASS, NEW TESLA AWD & TESLA RWD AND RARE BATTLEPASS LAMBO AVENTADOR

üíµPRICE IDR = 200K
üíµPRICE MY = 60RM
üíµPRICE OVERSEAS = 20$
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚äπ‚ä±‚ú´‚ä∞‚äπ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

.COLOR NAME  -20K

.INJECT PREMIUM CARS 1 MOBIL -20K

‚úÖPRICELIST SAFEBAN

Safeban Newbie
Unlock allmap
Max level
Silver 21M
Gold 10.000
50 mobil premium (Showroom tune)

Price : 100k

Safeban Pro
Gold & Silver 888M
Unlock allmap
40+ Drift tune car (include tesla RWD)

Price : 200k
        </div>
        <div class="p-4 bg-slate-800/30 border-t border-slate-800">
            <button onclick="closeModal('priceModal')" class="w-full bg-slate-800 p-3 rounded-2xl font-black text-[10px] uppercase shadow-lg">Tutup</button>
        </div>
    </div>
</div>

<div id="loginSection" class="flex h-screen items-center justify-center p-6 bg-slate-950">
    <div class="glass-card p-8 rounded-3xl w-full max-w-sm shadow-2xl">
        <h2 class="text-3xl font-black text-center mb-6 text-blue-400 italic">RIMURU</h2>
        <input type="text" id="user" placeholder="Username" class="w-full p-4 mb-3 bg-slate-900/50 rounded-2xl border border-slate-700 outline-none text-white text-center">
        <input type="password" id="pass" placeholder="Password" class="w-full p-4 mb-6 bg-slate-900/50 rounded-2xl border border-slate-700 outline-none text-white text-center">
        <button onclick="handleLogin()" id="btnLogin" class="w-full bg-blue-600 p-4 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-all">Masuk</button>
    </div>
</div>

<div id="appSection" class="hidden p-4 max-w-md mx-auto pb-12">
    <div class="flex justify-between items-center mb-6 mt-4">
        <div>
            <h1 class="text-xl font-black text-blue-400 italic">RIMURU STORE</h1>
            <p id="userStatusTag" class="text-[9px] text-slate-500 font-bold mt-2 tracking-widest uppercase italic"></p>
        </div>
        <div class="flex gap-2">
            <button onclick="openModal('userPassModal')" class="bg-blue-600/10 text-blue-400 px-4 py-2 rounded-xl text-[10px] font-black border border-blue-500/20 active:scale-90">PASS</button>
            <button onclick="handleLogout()" class="bg-red-500/10 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black border border-red-500/20 active:scale-90 transition-all">LOGOUT</button>
        </div>
    </div>

    <div class="glass-card p-4 rounded-2xl mb-6 flex justify-between items-center text-sm font-black italic shadow-inner">
        <span class="text-slate-400 text-[10px]">OMSET ANDA:</span>
        <span id="userRevenue" class="text-emerald-400">Rp 0</span>
    </div>

    <div class="grid grid-cols-2 gap-2 mb-2">
        <button onclick="openModal('priceModal')" class="glass-card p-4 rounded-2xl text-emerald-400 font-black text-[10px] tracking-widest shadow-lg active:scale-95">üìã PRICE RIMURU</button>
        <button onclick="openModal('updateModal')" class="glass-card p-4 rounded-2xl text-slate-400 font-black text-[10px] tracking-widest shadow-lg active:scale-95 italic">üì¢ WHAT'S NEW</button>
    </div>
    <button onclick="openModal('resellerModal')" class="w-full glass-card p-4 rounded-2xl text-blue-400 font-black text-[10px] tracking-[0.3em] mb-6 shadow-lg active:scale-95">üí∞ PRICE USERS</button>

    <div id="adminPanel" class="hidden mb-6 space-y-2">
        <div class="p-4 bg-orange-500/10 border border-orange-500/30 rounded-2xl">
            <h3 class="text-orange-400 font-black text-[10px] uppercase mb-4 tracking-widest text-center">üõ°Ô∏è ADMIN CONTROL PANEL</h3>
            
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 mb-4">
                <p class="text-[8px] text-slate-500 font-bold mb-2 text-center uppercase">Statistik Penjualan Paket</p>
                <canvas id="adminChart" class="w-full h-32"></canvas>
            </div>

            <div class="bg-slate-900/80 p-3 rounded-xl border border-orange-500/20 mb-4 flex justify-between items-center">
                <span class="text-slate-500 text-[9px] font-black uppercase italic">OMSET KESELURUHAN:</span>
                <span id="adminGlobalRevenue" class="text-orange-400 font-bold text-xs">Rp 0</span>
            </div>

            <button onclick="syncDatabase()" id="btnSync" class="w-full bg-emerald-600 hover:bg-emerald-700 p-4 rounded-2xl font-black text-[10px] uppercase shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95 mb-4">
                <span>üßπ RAPIHKAN SHEET</span>
            </button>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="showAdminFeature('addUser')" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-slate-300 border border-slate-700">+ USER</button>
                <button onclick="showAdminFeature('addStock')" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-slate-300 border border-slate-700">+ STOK</button>
                <button onclick="showAdminFeature('changePass')" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-slate-300 border border-slate-700">ADM PASS</button>
                <button onclick="location.reload()" class="bg-slate-900 p-3 rounded-xl text-[9px] font-bold text-slate-300 border border-slate-700">RELOAD</button>
            </div>
            <div id="adminForm" class="hidden mt-4 pt-4 border-t border-slate-800 space-y-3">
                <div id="formContent"></div>
                <button id="btnAdminSubmit" onclick="submitAdminAction()" class="w-full bg-orange-600 p-3 rounded-xl font-black text-[10px] uppercase">Submit Action</button>
            </div>
        </div>
    </div>

    <div class="glass-card p-6 rounded-[2rem] mb-6 shadow-xl border-t border-white/5">
        <label class="text-[10px] text-slate-400 font-bold mb-2 block uppercase px-1 tracking-widest italic">Pilih Paket:</label>
        <select id="paket" class="w-full p-4 mb-4 bg-slate-950 rounded-2xl border border-slate-800 text-sm text-white outline-none focus:border-blue-500"></select>
        <label class="text-[10px] text-slate-400 font-bold mb-2 block uppercase px-1 tracking-widest italic">Bukti Transfer:</label>
        <input type="file" id="bukti" accept="image/*" class="w-full text-xs text-slate-500 mb-6 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:bg-blue-600 file:text-white file:font-bold">
        <button id="btnGen" disabled onclick="handleGen()" class="w-full bg-blue-600 disabled:bg-slate-800 p-4 rounded-2xl font-black uppercase text-sm shadow-lg active:scale-95 transition-all">Generate Akun</button>
    </div>

    <div class="glass-card p-6 rounded-[2rem] mb-6 shadow-lg">
        <div class="flex justify-between items-center mb-4 px-1">
            <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest italic">Riwayat Transaksi</h3>
            <span class="text-[8px] text-emerald-500 font-bold uppercase tracking-tighter">Border Hijau = Terbaru</span>
        </div>
        <div id="historyList" class="space-y-3 max-h-80 overflow-y-auto px-1 custom-scrollbar"></div>
    </div>
</div>

<script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzRwk8CtNXjuwGRVoxsA88KxNAzy-29BSovXFweLh-MChRkeFXOheJgVHyhuF-VaOE/exec"; 
    const PAKET_LIST = ["Paket 10k", "Paket Hemat", "Paket 1", "Paket 2", "Paket 3", "Paket 4", "Paket 5", "Paket 6", "Safeban Newbie", "Safeban Pro"];
    let base64Img = ""; let lastImageKey = ""; let currentUser = ""; let currentAdminAction = "";

    window.onload = function() {
        const u = localStorage.getItem('rimuru_session'), r = localStorage.getItem('rimuru_role');
        if(u && r) { currentUser = u; showApp(r); }
    };

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function openModal(id) { document.getElementById(id).classList.remove('hidden'); }

    function handleLogin() {
        const user = document.getElementById('user').value, pass = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        if(!user || !pass) return alert("Isi Data!");
        btn.innerText = "CHECKING..."; btn.disabled = true;
        fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'login', user, pass})})
        .then(res => res.json()).then(data => {
            if(data.status === 'success') {
                currentUser = user; localStorage.setItem('rimuru_session', user); localStorage.setItem('rimuru_role', data.role);
                showApp(data.role);
            } else { alert(data.msg); btn.innerText = "Masuk"; btn.disabled = false; }
        });
    }

    // Modifikasi showApp untuk aktifkan tombol Gen jika Admin
    function showApp(role) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        document.getElementById('userStatusTag').innerText = "Logged in as : " + currentUser;
        
        if(role === 'admin') {
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('btnGen').disabled = false; // ADMIN LANGSUNG AKTIF
            fetchAdminStats();
        }
        updateStockUI(); loadHistory(); updateUserStats();
    }

    async function syncDatabase() {
        const btn = document.getElementById('btnSync');
        const originalText = btn.innerHTML;
        btn.innerHTML = "‚åõ MEMPROSES...";
        btn.disabled = true;
        try {
            const response = await fetch(WEBAPP_URL, {
                method: "POST",
                body: JSON.stringify({ action: "syncSheet" })
            });
            const data = await response.json();
            alert("‚ú® " + data.msg);
            location.reload();
        } catch (err) { alert("‚ö†Ô∏è Gagal koneksi database."); }
        finally { btn.innerHTML = originalText; btn.disabled = false; }
    }

    async function submitUserPass(event) {
        if(event) { event.preventDefault(); event.stopPropagation(); }
        const pass = document.getElementById('u_newpass').value;
        const btn = document.getElementById('btnUserPass');
        if(!pass) return alert("Isi Password Baru!");
        btn.innerText = "MEMPROSES..."; btn.disabled = true;
        try {
            const response = await fetch(WEBAPP_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'changePass', user: currentUser, newPass: pass })
            });
            const data = await response.json();
            if(data.status === 'success') {
                alert("‚úÖ Password Berhasil Diubah!");
                document.getElementById('u_newpass').value = "";
                closeModal('userPassModal');
            } else { alert("‚ùå Gagal: " + data.msg); btn.innerText = "Simpan Password"; btn.disabled = false; }
        } catch(e) { console.error(e); alert("Terjadi gangguan koneksi."); btn.innerText = "Simpan Password"; btn.disabled = false; }
    }

    async function fetchAdminStats() {
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'getStats'})});
        const data = await res.json();
        document.getElementById('adminGlobalRevenue').innerText = "Rp " + (data.revenue || 0).toLocaleString();
        
        if(data.chartData) {
            const ctx = document.getElementById('adminChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data.chartData),
                    datasets: [{
                        label: 'Terjual',
                        data: Object.values(data.chartData),
                        backgroundColor: '#3b82f6',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#1e293b' } }, x: { grid: { display: false } } }
                }
            });
        }
    }

    async function updateUserStats() {
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'getUserStats', user:currentUser})});
        const data = await res.json();
        document.getElementById('userRevenue').innerText = "Rp " + (data.revenue || 0).toLocaleString();
    }

    function showAdminFeature(type) {
        currentAdminAction = type;
        document.getElementById('adminForm').classList.remove('hidden');
        const content = document.getElementById('formContent');
        if(type === 'addUser') {
            content.innerHTML = `<input type="text" id="adm_user" placeholder="User Baru" class="w-full p-3 bg-slate-900 rounded-xl text-xs border border-slate-700">
                                 <input type="text" id="adm_pass" placeholder="Pass Baru" class="w-full p-3 bg-slate-900 rounded-xl text-xs border border-slate-700">`;
        } else if(type === 'addStock') {
            let opts = PAKET_LIST.map(p => `<option value="${p}">${p}</option>`).join('');
            content.innerHTML = `<select id="adm_paket" class="w-full p-3 bg-slate-900 rounded-xl text-xs border border-slate-700">${opts}</select>
                                 <textarea id="adm_data" placeholder="Email|Pass" class="w-full p-3 bg-slate-900 rounded-xl text-xs border border-slate-700 h-24"></textarea>`;
        } else if(type === 'changePass') {
            content.innerHTML = `<input type="password" id="adm_newpass" placeholder="Pass Baru Anda (Admin)" class="w-full p-3 bg-slate-900 rounded-xl text-xs border border-slate-700">`;
        }
    }

    async function submitAdminAction() {
        const btn = document.getElementById('btnAdminSubmit');
        btn.innerText = "PROSES..."; btn.disabled = true;
        let payload = { action: currentAdminAction, user: currentUser };
        if(currentAdminAction === 'addUser') { payload.newUser = document.getElementById('adm_user').value; payload.newPass = document.getElementById('adm_pass').value; }
        else if(currentAdminAction === 'addStock') { payload.paket = document.getElementById('adm_paket').value; payload.dataAkun = document.getElementById('adm_data').value; }
        else if(currentAdminAction === 'changePass') { payload.newPass = document.getElementById('adm_newpass').value; }
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify(payload)});
        const data = await res.json();
        alert(data.msg); location.reload();
    }

    // --- BAGIAN LOGIKA DINAMIS FRONTEND ---
    document.getElementById('bukti').onchange = (e) => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = () => { 
            base64Img = r.result; 
            document.getElementById('btnGen').disabled = false; 
        };
        r.readAsDataURL(file);
    };

    async function handleGen() {
        const btn = document.getElementById('btnGen'); btn.innerText = "GENERATE..."; btn.disabled = true;
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'generate', user:currentUser, paket:document.getElementById('paket').value, image:base64Img})});
        const data = await res.json();
        if(data.status === 'success') {
            document.getElementById('resPaket').innerText = data.paket;
            document.getElementById('resAccount').innerText = data.email + " | " + data.pass;
            openModal('resultModal');
        } else { alert(data.msg); btn.innerText = "Generate Akun"; btn.disabled = false; }
    }

    function copyAccountResult() {
        const text = document.getElementById('resAccount').innerText;
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        alert("‚úÖ Akun disalin!");
        document.body.removeChild(textArea);
    }

    async function loadHistory() {
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'getHistory', user:currentUser})});
        const data = await res.json();
        const container = document.getElementById('historyList');
        if(!data.data.length) { container.innerHTML = '<p class="text-center text-[10px] text-slate-600 italic">No History</p>'; return; }
        
        container.innerHTML = data.data.map(h => {
            const dateObj = h.ts ? new Date(h.ts) : null;
            const dateStr = dateObj ? dateObj.toLocaleString('id-ID', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' }) : '---';
            
            return `
            <div class="bg-slate-900/50 p-4 rounded-2xl flex justify-between items-center border-l-4 ${h.isLast ? 'border-emerald-500 bg-emerald-500/10' : 'border-blue-500'} mb-2 shadow-lg">
                <div class="flex-1 pr-2">
                    <div class="flex justify-between items-start mb-1">
                        <p class="text-[9px] font-black ${h.isLast ? 'text-emerald-400' : 'text-blue-400'} uppercase">${h.paket}</p>
                        <span class="text-[8px] text-slate-500 font-bold">${dateStr}</span>
                    </div>
                    <p class="text-xs font-mono text-white opacity-80">${h.email} | ${h.pass}</p>
                </div>
                <button onclick="navigator.clipboard.writeText('${h.email} | ${h.pass}').then(()=>alert('Copied!'))" class="bg-slate-800 p-3 rounded-xl active:scale-90"><svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg></button>
            </div>`;
        }).join('');
    }

    async function updateStockUI() {
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'getStockDetail'})});
        const data = await res.json();
        document.getElementById('paket').innerHTML = PAKET_LIST.map(p => {
            const stock = data.stockMap[p] || 0;
            const isLow = stock > 0 && stock < 3;
            return `<option value="${p}" ${stock===0?'disabled':''} class="${isLow ? 'text-red-500' : ''}">
                ${p} (${stock} ${isLow ? 'üî• LIMIT!' : 'Ready'})
            </option>`;
        }).join('');
    }

    function handleLogout() {
        if (confirm("Apakah Anda yakin ingin keluar dari Rimuru Store?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
