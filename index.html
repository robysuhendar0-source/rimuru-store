<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rimuru Store V3.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-user-select: none; background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes bounceIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="loginSection" class="flex h-screen items-center justify-center p-6">
    <div class="bg-slate-800 p-8 rounded-3xl border border-blue-500/30 w-full max-w-sm shadow-2xl">
        <h2 class="text-3xl font-black text-center mb-6 text-blue-400 italic">RIMURU</h2>
        <input type="text" id="user" placeholder="Username" class="w-full p-4 mb-3 bg-slate-900 rounded-2xl border border-slate-700 outline-none text-white">
        <input type="password" id="pass" placeholder="Password" class="w-full p-4 mb-6 bg-slate-900 rounded-2xl border border-slate-700 outline-none text-white">
        <button onclick="handleLogin()" class="w-full bg-blue-600 p-4 rounded-2xl font-bold active:scale-95 transition-all">LOGIN</button>
    </div>
</div>

<div id="appSection" class="hidden p-4 max-w-md mx-auto pb-12">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-black text-blue-400">RIMURU STORE</h1>
        <button onclick="handleLogout()" class="bg-red-500/20 text-red-500 px-4 py-2 rounded-xl text-[10px] font-bold border border-red-500/30">LOGOUT</button>
    </div>

    <div id="newAccountArea" class="hidden mb-6 animate-bounce-in">
        <div class="bg-emerald-600/10 border-2 border-emerald-500 p-6 rounded-[2rem] shadow-[0_0_20px_rgba(16,185,129,0.2)]">
            <h3 class="text-emerald-400 font-black text-[10px] uppercase tracking-widest mb-4 text-center">✨ PESANAN BERHASIL ✨</h3>
            <div class="bg-slate-900/80 p-5 rounded-2xl border border-emerald-500/30">
                <p id="newPaketName" class="text-[9px] font-black text-emerald-400 uppercase mb-1"></p>
                <p id="newAccountDetail" class="text-sm font-mono text-white break-all mb-4"></p>
                <button id="copyNewBtn" class="w-full bg-emerald-600 p-3 rounded-xl font-bold text-xs active:scale-95 transition-all">SALIN AKUN SEKARANG</button>
            </div>
        </div>
    </div>

    <div class="bg-slate-800 p-6 rounded-[2rem] border border-slate-700 mb-6">
        <div class="mb-4">
            <label class="text-[10px] text-slate-400 font-bold mb-2 block uppercase">Pilih Paket:</label>
            <select id="paket" class="w-full p-4 bg-slate-900 rounded-2xl border border-slate-700 text-sm text-white outline-none"></select>
        </div>
        <div class="mb-6">
            <label class="text-[10px] text-slate-400 font-bold mb-2 block uppercase">Upload Bukti:</label>
            <input type="file" id="bukti" accept="image/*" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:bg-blue-600 file:text-white">
        </div>
        <button id="btnGen" disabled onclick="handleGen()" class="w-full bg-blue-600 disabled:bg-slate-700 p-4 rounded-2xl font-black active:scale-95 transition-all uppercase text-sm">PROSES...</button>
    </div>

    <div class="bg-slate-800 p-6 rounded-[2rem] border border-slate-700 mb-6">
        <h3 class="text-xs font-black text-slate-500 uppercase mb-4 tracking-widest">Riwayat Transaksi</h3>
        <div id="historyList" class="space-y-3 max-h-80 overflow-y-auto"></div>
    </div>

    <div class="bg-slate-800 p-5 rounded-[2rem] border border-slate-700 flex gap-2">
        <input type="password" id="newPassInput" placeholder="Pass Baru" class="flex-1 p-3 bg-slate-900 rounded-xl border border-slate-700 text-xs text-center outline-none">
        <button onclick="changePass()" class="bg-orange-600 px-5 rounded-xl text-[10px] font-bold">UPDATE</button>
    </div>
</div>

<script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzRwk8CtNXjuwGRVoxsA88KxNAzy-29BSovXFweLh-MChRkeFXOheJgVHyhuF-VaOE/exec";
    const PAKET_LIST = ["Paket 10k", "Paket Hemat", "Paket 1", "Paket 2", "Paket 3", "Paket 4", "Paket 5", "Safeban Newbie", "Safeban Pro"];
    let base64Img = ""; let lastImageKey = ""; let currentUser = "";

    window.onload = function() {
        const u = localStorage.getItem('rimuru_session');
        const r = localStorage.getItem('rimuru_role');
        if(u && r) { currentUser = u; showApp(r); }
    };

    function handleLogin() {
        const user = document.getElementById('user').value;
        const pass = document.getElementById('pass').value;
        fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'login', user, pass})})
        .then(res => res.json()).then(data => {
            if(data.status === 'success') {
                currentUser = user; localStorage.setItem('rimuru_session', user); localStorage.setItem('rimuru_role', data.role);
                showApp(data.role);
            } else alert(data.msg);
        });
    }

    function showApp(role) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('appSection').classList.remove('hidden');
        updateStockUI(); loadHistory();
    }

    document.getElementById('bukti').onchange = (e) => {
        const file = e.target.files[0];
        const key = `${file.name}-${file.size}`;
        if(key === lastImageKey) { alert("Gambar Sama!"); e.target.value = ""; return; }
        const r = new FileReader();
        r.onload = () => { base64Img = r.result; lastImageKey = key; document.getElementById('btnGen').disabled = false; document.getElementById('btnGen').innerText = "GENERATE SEKARANG"; };
        r.readAsDataURL(file);
    };

    async function handleGen() {
        const btn = document.getElementById('btnGen');
        btn.innerText = "SEDANG MEMPROSES..."; btn.disabled = true;
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'generate', user:currentUser, paket:document.getElementById('paket').value, image:base64Img})});
        const data = await res.json();
        
        if(data.status === 'success') {
            // Tampilkan di Kotak Khusus Paling Atas
            document.getElementById('newAccountArea').classList.remove('hidden');
            document.getElementById('newPaketName').innerText = data.paket;
            document.getElementById('newAccountDetail').innerText = `${data.email} | ${data.pass}`;
            document.getElementById('copyNewBtn').onclick = () => copyToClipboard(`${data.email} | ${data.pass}`);
            
            // Scroll ke paling atas agar terlihat
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            loadHistory(); updateStockUI();
            document.getElementById('bukti').value = "";
            btn.innerText = "PROSES BERHASIL";
        } else alert(data.msg);
    }

    async function loadHistory() {
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'getHistory', user:currentUser})});
        const data = await res.json();
        const container = document.getElementById('historyList');
        container.innerHTML = data.data.map(h => `
            <div class="bg-slate-900 p-4 rounded-2xl border-l-4 border-blue-500 flex justify-between items-center mb-1">
                <div class="flex-1 min-w-0 pr-2">
                    <p class="text-[9px] font-black text-blue-400 uppercase">${h.paket}</p>
                    <p class="text-xs font-mono text-white truncate opacity-80">${h.email} | ${h.pass}</p>
                </div>
                <button onclick="copyToClipboard('${h.email} | ${h.pass}')" class="bg-slate-800 p-3 rounded-xl active:bg-blue-600 transition-all">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                </button>
            </div>`).join('');
    }

    async function updateStockUI() {
        const res = await fetch(WEBAPP_URL, {method:'POST', body:JSON.stringify({action:'getStockDetail'})});
        const data = await res.json();
        document.getElementById('paket').innerHTML = PAKET_LIST.map(p => {
            const c = data.stockMap[p] || 0;
            return `<option value="${p}" ${c === 0 ? 'disabled' : ''}>${p} (${c} Ready)</option>`;
        }).join('');
    }

    function copyToClipboard(text) {
        const ta = document.createElement("textarea"); ta.value = text;
        document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        alert("Salin Berhasil!");
    }

    function handleLogout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
